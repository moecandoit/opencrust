<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>OpenCrust Chat</title>
  <style>
    @import url("https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&family=IBM+Plex+Mono:wght@400;500&display=swap");

    :root {
      --bg: #f7f4ee;
      --bg-accent: #efe8d8;
      --ink: #1c232b;
      --ink-soft: #5a6472;
      --panel: #fffdfa;
      --panel-edge: #d7d2c6;
      --elev: 0 12px 40px rgba(18, 25, 35, 0.1);
      --brand: #e06b2d;
      --brand-2: #f3ae3d;
      --online: #0d9a6f;
      --offline: #d03f3f;
      --sys: #eff3f6;
      --user: #2a4c6f;
      --assistant: #ffffff;
      --error: #ffe7e5;
    }

    * { box-sizing: border-box; }

    body {
      margin: 0;
      min-height: 100vh;
      color: var(--ink);
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      background:
        radial-gradient(1200px 700px at 0% -10%, #fde9d1 0%, transparent 60%),
        radial-gradient(1000px 700px at 100% -20%, #dae9f3 0%, transparent 58%),
        linear-gradient(180deg, var(--bg), var(--bg-accent));
    }

    .shell {
      max-width: 1180px;
      margin: 0 auto;
      padding: 24px;
    }

    .topbar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      margin-bottom: 16px;
    }

    .brand {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .badge {
      width: 30px;
      height: 30px;
      border-radius: 9px;
      background: linear-gradient(145deg, var(--brand), var(--brand-2));
      box-shadow: 0 7px 20px rgba(224, 107, 45, 0.38);
    }

    .title {
      margin: 0;
      font-size: 1.35rem;
      letter-spacing: 0.2px;
    }

    .subtitle {
      margin: 0;
      color: var(--ink-soft);
      font-size: 0.84rem;
    }

    .workspace {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 14px;
      align-items: start;
    }

    .panel {
      border: 1px solid var(--panel-edge);
      border-radius: 16px;
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.92), rgba(255, 252, 246, 0.92));
      box-shadow: var(--elev);
      overflow: hidden;
      animation: rise 360ms ease both;
    }

    .panel-head {
      padding: 14px 16px;
      border-bottom: 1px solid var(--panel-edge);
      background: rgba(255, 255, 255, 0.72);
    }

    .panel-head h2 {
      margin: 0;
      font-size: 1rem;
      letter-spacing: 0.25px;
    }

    .hint {
      margin: 6px 0 0;
      color: var(--ink-soft);
      font-size: 0.82rem;
      line-height: 1.35;
    }

    .sidebar-body {
      padding: 14px;
      display: grid;
      gap: 14px;
    }

    .status-group {
      display: grid;
      gap: 8px;
    }

    .status-group h3 {
      margin: 0;
      font-size: 0.82rem;
      text-transform: uppercase;
      letter-spacing: 0.6px;
      color: var(--ink-soft);
    }

    .status-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
      font-size: 0.83rem;
      color: var(--ink-soft);
    }

    .status-row code {
      color: #1f4e6f;
      font-family: "IBM Plex Mono", Consolas, monospace;
      font-size: 0.78rem;
      text-align: right;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 150px;
    }

    .status-dot {
      display: inline-block;
      width: 7px;
      height: 7px;
      border-radius: 50%;
      margin-right: 4px;
    }

    .dot-ok { background: var(--online); }
    .dot-off { background: var(--offline); }
    .dot-warn { background: #d4a017; }

    .channel-list {
      display: grid;
      gap: 4px;
    }

    .channel-tag {
      display: inline-flex;
      align-items: center;
      gap: 5px;
      padding: 4px 9px;
      border: 1px solid var(--panel-edge);
      border-radius: 8px;
      font-size: 0.78rem;
      background: #fff;
    }

    .no-channels {
      color: var(--ink-soft);
      font-size: 0.8rem;
      font-style: italic;
    }

    .gateway-key-section {
      display: grid;
      gap: 6px;
    }

    .gateway-key-section label {
      font-size: 0.82rem;
      color: var(--ink-soft);
      font-weight: 500;
    }

    .gateway-key-section input {
      width: 100%;
      border: 1px solid var(--panel-edge);
      border-radius: 10px;
      color: var(--ink);
      background: #ffffff;
      padding: 8px 10px;
      font-family: "IBM Plex Mono", Consolas, monospace;
      font-size: 0.82rem;
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }

    .gateway-key-section input:focus {
      outline: none;
      border-color: #cf7641;
      box-shadow: 0 0 0 3px rgba(224, 107, 45, 0.16);
    }

    .gateway-key-section .hint {
      font-size: 0.76rem;
      margin: 0;
    }

    .provider-select {
      width: 100%;
      border: 1px solid var(--panel-edge);
      border-radius: 10px;
      color: var(--ink);
      background: #ffffff;
      padding: 8px 10px;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      font-size: 0.84rem;
      cursor: pointer;
      transition: border-color 120ms ease, box-shadow 120ms ease;
      appearance: auto;
    }

    .provider-select:focus {
      outline: none;
      border-color: #cf7641;
      box-shadow: 0 0 0 3px rgba(224, 107, 45, 0.16);
    }

    .provider-status {
      font-size: 0.78rem;
      color: var(--ink-soft);
      min-height: 1.2em;
    }

    .provider-key-input {
      width: 100%;
      border: 1px solid var(--panel-edge);
      border-radius: 10px;
      color: var(--ink);
      background: #ffffff;
      padding: 8px 10px;
      font-family: "IBM Plex Mono", Consolas, monospace;
      font-size: 0.82rem;
      margin-bottom: 6px;
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }

    .provider-key-input:focus {
      outline: none;
      border-color: #cf7641;
      box-shadow: 0 0 0 3px rgba(224, 107, 45, 0.16);
    }

    .provider-activate-btn {
      width: 100%;
      border: none;
      color: #2f220e;
      background: linear-gradient(145deg, var(--brand), var(--brand-2));
      box-shadow: 0 6px 14px rgba(224, 107, 45, 0.22);
      border-radius: 10px;
      padding: 8px 12px;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      font-size: 0.84rem;
      font-weight: 600;
      cursor: pointer;
    }

    .pill {
      border: 1px solid var(--panel-edge);
      border-radius: 999px;
      padding: 6px 10px;
      font-size: 0.8rem;
      background: #fff;
      min-width: 118px;
      text-align: center;
    }

    .online { color: var(--online); font-weight: 700; }
    .offline { color: var(--offline); font-weight: 700; }

    .chat-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 10px;
      padding: 14px 16px;
      border-bottom: 1px solid var(--panel-edge);
      background: rgba(255, 255, 255, 0.7);
      flex-wrap: wrap;
    }

    .chat-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 8px 12px;
      color: var(--ink-soft);
      font-size: 0.84rem;
    }

    .chat {
      min-height: 52vh;
      max-height: 62vh;
      overflow-y: auto;
      padding: 18px;
      display: flex;
      flex-direction: column;
      gap: 11px;
      background:
        linear-gradient(180deg, rgba(255, 255, 255, 0.34), rgba(246, 241, 233, 0.5));
    }

    .msg {
      max-width: min(86%, 760px);
      border: 1px solid var(--panel-edge);
      border-radius: 14px;
      padding: 10px 12px;
      white-space: pre-wrap;
      word-wrap: break-word;
      line-height: 1.42;
      box-shadow: 0 6px 14px rgba(20, 30, 40, 0.06);
      animation: msg-in 220ms ease both;
    }

    .sys {
      align-self: center;
      background: var(--sys);
      color: var(--ink-soft);
      font-size: 0.82rem;
      border-style: dashed;
      box-shadow: none;
    }

    .user {
      align-self: flex-end;
      color: #eef5fb;
      border-color: #204362;
      background: linear-gradient(145deg, #2a4c6f, #1e3b59);
    }

    .assistant {
      align-self: flex-start;
      background: var(--assistant);
    }

    .error {
      align-self: flex-start;
      background: var(--error);
      border-color: #e89a91;
      color: #8b2b2b;
    }

    .controls {
      border-top: 1px solid var(--panel-edge);
      padding: 14px;
      display: grid;
      gap: 10px;
      background: rgba(255, 255, 255, 0.72);
    }

    .actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border: 1px solid #cfc6b5;
      border-radius: 10px;
      background: #fff;
      color: var(--ink);
      padding: 8px 12px;
      font-family: "Space Grotesk", "Segoe UI", sans-serif;
      font-size: 0.84rem;
      font-weight: 600;
      cursor: pointer;
      transition: transform 120ms ease, box-shadow 120ms ease, border-color 120ms ease;
    }

    button:hover {
      transform: translateY(-1px);
      border-color: #c9bca5;
      box-shadow: 0 7px 14px rgba(31, 42, 55, 0.1);
    }

    button.primary {
      border: none;
      color: #2f220e;
      background: linear-gradient(145deg, var(--brand), var(--brand-2));
      box-shadow: 0 10px 18px rgba(224, 107, 45, 0.28);
    }

    .composer {
      display: grid;
      grid-template-columns: 1fr auto;
      gap: 8px;
      align-items: end;
    }

    textarea {
      width: 100%;
      min-height: 66px;
      max-height: 190px;
      resize: vertical;
      border: 1px solid var(--panel-edge);
      border-radius: 10px;
      color: var(--ink);
      background: #ffffff;
      padding: 10px 11px;
      font-family: "IBM Plex Mono", Consolas, monospace;
      font-size: 0.9rem;
      line-height: 1.4;
      transition: border-color 120ms ease, box-shadow 120ms ease;
    }

    textarea:focus {
      outline: none;
      border-color: #cf7641;
      box-shadow: 0 0 0 3px rgba(224, 107, 45, 0.16);
    }

    .divider {
      border: none;
      border-top: 1px solid var(--panel-edge);
      margin: 2px 0;
    }

    @keyframes rise {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes msg-in {
      from { opacity: 0; transform: translateY(5px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @media (max-width: 980px) {
      .shell { padding: 14px; }
      .workspace { grid-template-columns: 1fr; }
      .chat { min-height: 44vh; max-height: 56vh; }
      .composer { grid-template-columns: 1fr; }
      .composer button { width: 100%; }
    }
  </style>
</head>
<body>
  <main class="shell">
    <header class="topbar">
      <div class="brand">
        <div class="badge"></div>
        <div>
          <h1 class="title">OpenCrust</h1>
          <p class="subtitle">Your personal AI assistant</p>
        </div>
      </div>
      <div class="pill" id="conn-pill"><span class="offline">Disconnected</span></div>
    </header>

    <div class="workspace">
      <aside class="panel">
        <div class="panel-head">
          <h2>Status</h2>
        </div>
        <div class="sidebar-body">
          <div class="status-group">
            <h3>Gateway</h3>
            <div class="status-row">
              <span>Server</span>
              <code id="api-status">checking...</code>
            </div>
            <div class="status-row">
              <span>Session</span>
              <code id="session">none</code>
            </div>
            <div class="status-row">
              <span>Active sessions</span>
              <code id="session-count">-</code>
            </div>
          </div>

          <hr class="divider">

          <div class="status-group">
            <h3>Channels</h3>
            <div id="channel-list" class="channel-list">
              <span class="no-channels">No channels connected</span>
            </div>
          </div>

          <hr class="divider">

          <div class="status-group">
            <h3>LLM Provider</h3>
            <select id="provider-select" class="provider-select">
              <option value="">Loading...</option>
            </select>
            <div id="provider-status" class="provider-status"></div>
            <div id="provider-key-section" style="display:none">
              <input id="provider-api-key" type="password" placeholder="Enter API key..." autocomplete="off" class="provider-key-input">
              <button id="provider-activate" class="provider-activate-btn">Save & Activate</button>
            </div>
          </div>

          <div id="auth-section" class="gateway-key-section" style="display:none">
            <hr class="divider">
            <label for="key-gateway">Gateway API Key</label>
            <input id="key-gateway" type="password" placeholder="Enter your gateway key" autocomplete="off">
            <p class="hint">This gateway requires authentication.</p>
            <button id="auth-connect">Connect</button>
          </div>

          <div class="actions">
            <button id="refresh">Refresh</button>
          </div>
        </div>
      </aside>

      <section class="panel">
        <div class="chat-top">
          <div class="chat-meta">
            <span>Chat</span>
            <span>Enter sends, Shift+Enter newline</span>
          </div>
          <div class="actions">
            <button id="reconnect">Reconnect</button>
            <button id="clear">New Chat</button>
          </div>
        </div>

        <div id="chat" class="chat"></div>

        <div class="controls">
          <div class="composer">
            <textarea id="input" placeholder="Type a message..."></textarea>
            <button id="send" class="primary">Send</button>
          </div>
        </div>
      </section>
    </div>
  </main>

  <script>
    const chatEl = document.getElementById("chat");
    const inputEl = document.getElementById("input");
    const sendBtn = document.getElementById("send");
    const reconnectBtn = document.getElementById("reconnect");
    const refreshBtn = document.getElementById("refresh");
    const clearBtn = document.getElementById("clear");
    const connPill = document.getElementById("conn-pill");
    const sessionEl = document.getElementById("session");
    const apiStatusEl = document.getElementById("api-status");
    const sessionCountEl = document.getElementById("session-count");
    const channelListEl = document.getElementById("channel-list");
    const providerSelect = document.getElementById("provider-select");
    const providerStatus = document.getElementById("provider-status");
    const providerKeySection = document.getElementById("provider-key-section");
    const providerApiKey = document.getElementById("provider-api-key");
    const providerActivateBtn = document.getElementById("provider-activate");
    const authSection = document.getElementById("auth-section");
    const keyGatewayEl = document.getElementById("key-gateway");
    const authConnectBtn = document.getElementById("auth-connect");

    const storageKey = "opencrust.session_id";
    const keyStorage = "opencrust.gateway_key";
    const providerStorage = "opencrust.provider";
    let sessionId = localStorage.getItem(storageKey) || "";
    let gatewayKey = localStorage.getItem(keyStorage) || "";
    let selectedProvider = localStorage.getItem(providerStorage) || "";
    let authRequired = false;
    let socket = null;
    let reconnectTimer = null;
    let providerData = [];

    // Pre-fill saved key
    keyGatewayEl.value = gatewayKey;

    function wsUrl() {
      const proto = location.protocol === "https:" ? "wss:" : "ws:";
      const base = `${proto}//${location.host}/ws`;
      const key = gatewayKey || keyGatewayEl.value.trim();
      return key ? `${base}?token=${encodeURIComponent(key)}` : base;
    }

    function setConnectionState(isConnected) {
      connPill.innerHTML = isConnected
        ? '<span class="online">Connected</span>'
        : '<span class="offline">Disconnected</span>';
    }

    function setSession(id) {
      sessionId = id || "";
      if (sessionId) {
        localStorage.setItem(storageKey, sessionId);
        sessionEl.textContent = sessionId.slice(0, 8) + "...";
        sessionEl.title = sessionId;
      } else {
        localStorage.removeItem(storageKey);
        sessionEl.textContent = "none";
        sessionEl.title = "";
      }
    }

    function appendMessage(kind, text) {
      const div = document.createElement("div");
      div.className = `msg ${kind}`;
      div.textContent = text;
      chatEl.appendChild(div);
      chatEl.scrollTop = chatEl.scrollHeight;
    }

    async function refreshStatus() {
      try {
        const r = await fetch("/api/status");
        const j = await r.json();
        apiStatusEl.innerHTML = `<span class="status-dot dot-ok"></span>${j.status}`;
        sessionCountEl.textContent = j.sessions;

        if (j.channels && j.channels.length > 0) {
          channelListEl.innerHTML = j.channels
            .map(ch => `<span class="channel-tag"><span class="status-dot dot-ok"></span>${ch}</span>`)
            .join("");
        } else {
          channelListEl.innerHTML = '<span class="no-channels">None configured</span>';
        }
      } catch {
        apiStatusEl.innerHTML = '<span class="status-dot dot-off"></span>unavailable';
        sessionCountEl.textContent = "-";
        channelListEl.innerHTML = '<span class="no-channels">-</span>';
      }

      loadProviders();
    }

    async function loadProviders() {
      try {
        const r = await fetch("/api/providers");
        const j = await r.json();
        providerData = j.providers || [];

        providerSelect.innerHTML = "";
        for (const p of providerData) {
          const opt = document.createElement("option");
          opt.value = p.id;
          opt.textContent = p.active ? p.display_name : `${p.display_name} (not configured)`;
          providerSelect.appendChild(opt);
        }

        // Restore saved selection, or pick the default
        const defaultProvider = providerData.find(p => p.is_default);
        const saved = selectedProvider || (defaultProvider ? defaultProvider.id : "");
        if (saved && [...providerSelect.options].some(o => o.value === saved)) {
          providerSelect.value = saved;
        }
        updateProviderUI();
      } catch {
        providerSelect.innerHTML = '<option value="">unavailable</option>';
        providerStatus.textContent = "";
      }
    }

    function updateProviderUI() {
      const id = providerSelect.value;
      const p = providerData.find(x => x.id === id);
      if (!p) {
        providerStatus.textContent = "";
        providerKeySection.style.display = "none";
        return;
      }
      if (p.active) {
        const tag = p.is_default ? "active, default" : "active";
        providerStatus.innerHTML = `<span class="status-dot dot-ok"></span>${tag}`;
        providerKeySection.style.display = "none";
      } else {
        providerStatus.innerHTML = `<span class="status-dot dot-off"></span>not configured`;
        providerKeySection.style.display = p.needs_api_key ? "" : "none";
      }
      selectedProvider = id;
      localStorage.setItem(providerStorage, id);
    }

    providerSelect.addEventListener("change", () => {
      updateProviderUI();
      // If switching to an active provider, tell the backend to use it as default
      const p = providerData.find(x => x.id === providerSelect.value);
      if (p && p.active) {
        fetch("/api/providers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ provider_type: p.id, set_default: true }),
        }).then(() => loadProviders());
      }
    });

    providerActivateBtn.addEventListener("click", async () => {
      const id = providerSelect.value;
      const key = providerApiKey.value.trim();
      if (!key) return;

      providerActivateBtn.textContent = "Activating...";
      providerActivateBtn.disabled = true;

      try {
        const r = await fetch("/api/providers", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ provider_type: id, api_key: key, set_default: true }),
        });
        const j = await r.json();
        if (r.ok) {
          providerApiKey.value = "";
          appendMessage("sys", `Provider ${id} activated.`);
          await loadProviders();
        } else {
          appendMessage("error", j.message || "Failed to activate provider.");
        }
      } catch (e) {
        appendMessage("error", `Failed to activate provider: ${e}`);
      } finally {
        providerActivateBtn.textContent = "Save & Activate";
        providerActivateBtn.disabled = false;
      }
    });

    function scheduleReconnect() {
      if (reconnectTimer) return;
      reconnectTimer = setTimeout(() => {
        reconnectTimer = null;
        connect();
      }, 2000);
    }

    function handleServerEvent(raw) {
      let evt;
      try {
        evt = JSON.parse(raw);
      } catch {
        appendMessage("sys", `Raw: ${raw}`);
        return;
      }

      if (evt.session_id) setSession(evt.session_id);

      switch (evt.type) {
        case "connected":
          if (evt.note) {
            appendMessage("sys", `Connected (${evt.note}).`);
          }
          refreshStatus();
          break;
        case "resumed":
          appendMessage("sys", `Session resumed (${evt.history_length ?? 0} messages in history).`);
          refreshStatus();
          break;
        case "message":
          appendMessage("assistant", evt.content || "(empty response)");
          break;
        case "error":
          appendMessage("error", `${evt.code || "error"}: ${evt.message || "unknown error"}`);
          break;
        default:
          appendMessage("sys", `Event ${evt.type || "unknown"}: ${JSON.stringify(evt)}`);
      }
    }

    function connect() {
      if (socket && (socket.readyState === WebSocket.OPEN || socket.readyState === WebSocket.CONNECTING)) {
        return;
      }

      socket = new WebSocket(wsUrl());

      socket.onopen = () => {
        setConnectionState(true);
        if (sessionId) {
          socket.send(JSON.stringify({ type: "resume", session_id: sessionId }));
        } else {
          socket.send(JSON.stringify({ type: "init" }));
        }
      };

      socket.onmessage = (ev) => handleServerEvent(ev.data);

      socket.onclose = () => {
        setConnectionState(false);
        scheduleReconnect();
      };

      socket.onerror = () => {
        setConnectionState(false);
      };
    }

    function reconnectFresh() {
      if (reconnectTimer) {
        clearTimeout(reconnectTimer);
        reconnectTimer = null;
      }
      if (socket) {
        socket.onclose = null;
        try { socket.close(); } catch {}
        socket = null;
      }
      setConnectionState(false);
      connect();
    }

    function sendMessage() {
      const content = inputEl.value.trim();
      if (!content) return;

      if (!socket || socket.readyState !== WebSocket.OPEN) {
        appendMessage("error", "Not connected. Click Reconnect to try again.");
        return;
      }

      appendMessage("user", content);
      const msg = { content };
      const pid = providerSelect.value;
      if (pid) msg.provider = pid;
      socket.send(JSON.stringify(msg));
      inputEl.value = "";
      inputEl.focus();
    }

    sendBtn.addEventListener("click", sendMessage);
    inputEl.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    reconnectBtn.addEventListener("click", () => {
      reconnectFresh();
    });

    clearBtn.addEventListener("click", () => {
      chatEl.innerHTML = "";
      setSession("");
      reconnectFresh();
    });

    refreshBtn.addEventListener("click", refreshStatus);

    authConnectBtn.addEventListener("click", () => {
      gatewayKey = keyGatewayEl.value.trim();
      if (gatewayKey) {
        localStorage.setItem(keyStorage, gatewayKey);
      }
      reconnectFresh();
    });

    // Boot: check if auth is required, then connect
    async function boot() {
      setConnectionState(false);
      setSession(sessionId);
      refreshStatus();

      try {
        const r = await fetch("/api/auth-check");
        const j = await r.json();
        authRequired = j.auth_required;
      } catch {
        authRequired = false;
      }

      if (authRequired) {
        authSection.style.display = "";
        if (gatewayKey) {
          // Have a saved key â€” try connecting with it
          connect();
        } else {
          appendMessage("sys", "This gateway requires an API key. Enter it in the sidebar.");
        }
      } else {
        authSection.style.display = "none";
        connect();
      }
    }

    boot();
  </script>
</body>
</html>
